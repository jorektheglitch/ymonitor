<!DOCTYPE html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Storm Monitoring</title>
	<style>
		.centered {
			margin: 0 auto;
		}
		.center_t {
			text-align: center;
		}
		table {
			margin: 0 auto;
			border: 2px solid black;
		}
		tr:first-child {
			padding-left: 20%;
			padding-right: 20%;
		}
		th {
			border: 1px solid black;
			text-align: center;
		}
		td {
			white-space: nowrap;
			text-align: center;
		}
		td:first-child {
			text-align: left;
			border-right: 1px solid gray;
			padding-left: 0.5em;
			padding-right: 0.5em;
		}
	</style>
</head>

<body>
	<h3 class="center_t">Yggdrasil Storm Monitoring</h3>
	<h4 class="center_t" id="intervals">Interval: </h4></div>
	<div class="centered">
		<noscript>
			<p>This page requires JavaScript</p>
		</noscript>
		<table id="shifts">
			<tr>
				<th>Start of hour</th>
				<th>Coords shifts</th>
			</tr>
		</table>
	</div>
	<script async src="/dateformat.js"></script>
	<script async>
		let base_url = location.protocol+'//'+
			location.hostname+
			(location.port?":"+location.port:"")+
			location.pathname+
			(location.search?location.search:"");
		let div = document.getElementById("intervals");
		let intervals = [
			["day", "day"], ["week", "week"], 
			["half of mounth", "halfmounth"], 
			["all time", "all"]
		];
		for (let [name, keyword] of intervals){
			let link = document.createElement("a");
			link.innerText = name;
			link.setAttribute("href", `${base_url}#${keyword}`);
			div.append(link);
			div.innerHTML += " ";
		};
	</script>
	<script defer>
		const sortNum = (a, b) => parseInt(a) - parseInt(b);
		const table = document.getElementById("shifts");
		const clean_table = table.innerHTML;
		function safe_get_lochash(params) {
			let hash = location.hash.substring(1);
			if (["day", "week", "halfmounth", "all"].includes(hash)){
				return hash;
			} else {
				return "day"
			};
		};
		async function upd_table() {
			let path = `/api/${safe_get_lochash()}/by_hour`;
			const res = await fetch(path);
			const data = await res.json();
			if (data) {
				table.innerHTML = clean_table;
			};
			for (const hour of Object.keys(data).sort(sortNum)) {
				const el = document.createElement("tr");
				const date = new Date((hour | 0) * 1000);
				let dt_field = document.createElement("td");
				dt_field.innerText = `${date.format("dd.mm.yyyy HH")}:00`;
				let shifts_feld = document.createElement("td");
				shifts_feld.innerText = `${data[hour]}`;
				el.append(dt_field);
				el.append(shifts_feld);
				table.append(el);
			};
		};
		function upd_table_or_err() {
			upd_table().then(
				(success) => {
					del_err();
				},
				(error) => {
					show_err();
				});
		};
		function show_err(error) {
			let err_msg = document.getElementsByClassName("error_message")[0];
			if (!err_msg) {
				let err_msg = document.createElement("h6");
				err_msg.className = "error_message center_t";
				err_msg.innerText = `\
				Can't fetch shifts from server.\n\
				Reason: ${error}.\n\n\
				Please wait or try to reload page.\n`;
				table.before(err_msg);
			};
			console.error(error);
		}
		function del_err() {
			let err_msg = document.getElementsByClassName("error_message")[0];
			if (err_msg) {
				err_msg.remove();
			};
		};
		upd_table_or_err();
		setInterval(upd_table_or_err, 5 * 1000);
	</script>
</body>